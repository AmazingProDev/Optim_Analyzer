<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Cracker Pro - Nemo Visualizer</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì°</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css?v=29">
    <link rel="stylesheet" href="grid_styles.css?v=1">
    <link rel="stylesheet" href="additional_styles.css?v=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <div id="app">
        <header>
            <div class="logo">Log Cracker Pro</div>
            <div class="controls">
                <input type="file" id="fileInput" accept=".nmf">
                <label for="fileInput" class="btn">Load NMF</label>

                <input type="file" id="siteInput" accept=".xlsx, .xls, .csv" style="display:none;">
                <label for="siteInput" class="btn" style="background:#2563eb;">Import Sites</label>

                <button id="siteSettingsBtn" class="btn" style="background:#4b5563;">‚öôÔ∏è</button>

                <span id="fileStatus">No file loaded</span>
            </div>

            <!-- Site Settings Panel -->
            <div id="siteSettingsPanel" class="settings-panel">
                <h4 class="settings-header">Site Settings
                </h4>

                <div class="setting-item">
                    <label class="setting-label">Range (m): <span id="valRange">200</span></label>
                    <input type="range" id="rangeSiteDist" min="50" max="3000" step="50" value="200"
                        class="setting-input" aria-label="Site Range">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Beamwidth (¬∞): <span id="valBeam">60</span></label>
                    <input type="range" id="rangeIconBeam" min="10" max="180" step="5" value="60" class="setting-input"
                        aria-label="Icon Beamwidth">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Opacity: <span id="valOpacity">0.6</span></label>
                    <input type="range" id="rangeSiteOpacity" min="0.1" max="1" step="0.1" value="0.6"
                        class="setting-input" aria-label="Site Opacity">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Color Override</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="color" id="pickerSiteColor" value="#3b82f6"
                            style="border:none; width:30px; height:30px; cursor:pointer;"
                            aria-label="Site Color Picker">
                        <label style="font-size:11px; color:#888;"><input type="checkbox" id="checkSiteColorOverride">
                            Apply</label>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Labels</label>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <label style="font-size:11px; color:#888;"><input type="checkbox" id="checkShowSiteNames"> Show
                            Site Names</label>
                        <label style="font-size:11px; color:#888;"><input type="checkbox" id="checkShowCellNames"> Show
                            Cell Names</label>
                    </div>
                </div>

                <div style="text-align:right;">
                    <button id="closeSiteSettings"
                        style="background:#555; color:white; border:none; padding:4px 10px; cursor:pointer; font-size:11px; border-radius:3px;">Close</button>
                </div>
            </div>
            <div class="stats" id="statsDisplay">
                <!-- Stats will go here -->
            </div>
        </header>

        <main>
            <div id="logs-sidebar" style="display:flex; flex-direction:column;">
                <h3>Loaded Logs</h3>
                <div id="logsList" style="flex:1; overflow-y:auto; margin-bottom:10px;">
                    <div class="empty-state">No logs loaded</div>
                </div>

                <!-- Docked Views Container REMOVED -->
            </div>

            <div id="center-pane"
                style="flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden;">
                <div id="map" style="flex: 1;"></div>

                <!-- Bottom Panel for Docked Views (Legacy/Bottom) -->
                <div id="bottomPanel"
                    style="height: 0; display: none; flex-direction: column; background: #1e1e1e; border-top: 1px solid #444;">
                    <div id="bottomResizer"
                        style="height: 5px; background: #333; cursor: ns-resize; flex-shrink: 0; display: flex; justify-content: center; align-items: center;">
                        <div style="width: 30px; height: 2px; background: #555; border-radius: 1px;"></div>
                    </div>
                    <div id="bottomContent" style="flex: 1; display: flex; overflow: hidden;">
                        <!-- Docked Content Will Go Here -->
                        <div id="dockedChart"
                            style="flex: 1; display: none; border-right: 1px solid #333; position: relative; flex-direction: column;">
                        </div>
                        <div id="dockedSignaling"
                            style="flex: 1; display: none; border-right: 1px solid #333; position: relative; flex-direction: column;">
                        </div>
                        <div id="dockedGrid"
                            style="flex: 1; display: none; position: relative; flex-direction: column;">
                            <div class="docked-item-header"
                                style="display:none; /* Dynamic Header usually handled by moving modal header */">
                                <!-- Placeholders if needed -->
                            </div>
                            <!-- Helper Container for body -->
                            <div id="dockedGridBody" style="flex:1; overflow:auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebar" class="hidden">
                <h3>Point Details</h3>
                <div id="pointDetails"></div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Signaling Modal -->
    <div id="signalingModal" class="modal">
        <div class="modal-content"
            style="width:80%; max-width:900px; background:#1e1e1e; border:1px solid #444; height:80vh; display:flex; flex-direction:column; padding:0;">
            <div class="modal-header"
                style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <h3 id="signalingModalTitle" style="margin:0; color:#ddd;">Signaling Data</h3>
                    <select id="signalingFilter" onchange="filterSignaling()"
                        style="background:#333; color:#eee; border:1px solid #555; padding:4px 8px; border-radius:4px; font-size:12px;"
                        aria-label="Signaling Type Filter">
                        <option value="ALL">All Types</option>
                        <option value="RRC">RRC Only</option>
                        <option value="L3">L3 Only</option>
                    </select>
                </div>
                <span class="close" onclick="closeSignalingModal()"
                    style="color:#aaa; cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div class="modal-body" style="flex:1; overflow-y:auto; padding:0;">
                <table class="data-table" style="width:100%; border-collapse:collapse; font-size:12px;">
                    <thead style="position:sticky; top:0; background:#252525; z-index:10;">
                        <tr>
                            <th style="text-align:left; padding:8px;">Time
                            </th>
                            <th style="text-align:left; padding:8px;">Type
                            </th>
                            <th style="text-align:left; padding:8px;">
                                Direction</th>
                            <th style="text-align:left; padding:8px;">Message
                            </th>
                            <th style="text-align:left; padding:8px;">Details
                            </th>
                        </tr>
                    </thead>
                    <tbody id="signalingTableBody">
                        <!-- Data rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Grid Modal -->
    <div id="gridModal" class="modal"
        style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content"
            style="background-color: #1e1e1e; margin: 5% auto; padding: 0; border: 1px solid #444; width: 80%; height: 70%; display: flex; flex-direction: column; resize: both; overflow: hidden; position: relative;">

            <!-- Header (Draggable) -->
            <div class="modal-header grid-modal-header"
                style="padding: 10px; background: #252525; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; cursor: move; flex-shrink: 0;">
                <h3 class="grid-title" style="margin: 0; font-size: 14px; color: #eee; pointer-events: none;">Grid View
                </h3>
                <div class="grid-controls" style="display: flex; gap: 8px; pointer-events: auto;">
                    <button class="btn btn-sm btn-secondary" onclick="sortGrid()">Sort</button>
                    <button class="btn btn-sm btn-secondary" onclick="window.exportGridToCSV()">Export CSV</button>
                    <!-- Dock Button -->
                    <button class="dock-btn" onclick="toggleGridDock()" title="Dock"
                        style="background:#3b82f6; color:white; border:none; padding:4px 10px; cursor:pointer; font-size:14px; border-radius:3px;">&#8595;</button>
                    <span class="close" onclick="document.getElementById('gridModal').style.display='none'"
                        style="color: #aaa; font-size: 24px; font-weight: bold; cursor: pointer; line-height: 16px;">&times;</span>
                </div>
            </div>

            <!-- Body -->
            <div id="gridBody" class="modal-body grid-body"
                style="flex: 1; padding: 10px; overflow: auto; color: #ddd; position: relative;">
                <!-- Grid Table Generated via JS -->
                <div style="text-align:center; color:#666; padding:20px;">
                    Drag metrics from the sidebar here to add columns.<br>
                    (e.g. Serving RSCP, EcNo, SC, etc.)
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div id="chartModal" class="modal">
        <div class="modal-content"
            style="width:90%; height:90%; background:#1e1e1e; border:1px solid #444; display:flex; flex-direction:column; padding:0;">
            <div class="modal-header"
                style="padding:10px; background:#252525; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="chartTitle" style="margin:0; font-size:16px; color:#ddd;">Chart</h3>
                <span class="close" onclick="closeChartModal()"
                    style="color:#aaa; cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="flex:1; position:relative; padding:10px; min-height:0;">
                <canvas id="chartCanvas"></canvas>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <!-- Context Menu -->
    <div id="metricContextMenu" class="context-menu"
        style="display: none; position: absolute; z-index: 10000; background: #2d2d2d; border: 1px solid #444; border-radius: 4px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); padding: 5px 0; min-width: 150px;">
        <div class="menu-item" onclick="window.handleContextAction('map')"
            style="padding: 8px 15px; cursor: pointer; color: #e0e0e0;">Open in Map</div>
        <div class="menu-item" onclick="window.handleContextAction('chart')"
            style="padding: 8px 15px; cursor: pointer; color: #e0e0e0;">Open in Chart</div>
        <div class="menu-item" onclick="window.handleContextAction('grid')"
            style="padding: 8px 15px; cursor: pointer; color: #e0e0e0;">Open in Grid</div>
    </div>


    <!-- Grid Modal -->
    <div id="gridModal" class="modal"
        style="display:none; position:fixed; top:120px; left:320px; width:600px; height:400px; background:#1e1e1e; border:1px solid #444; z-index:2001; flex-direction:column; box-shadow:0 0 20px rgba(0,0,0,0.8); resize:both; overflow:hidden; min-width:400px; min-height:300px;">
        <div class="modal-content-grid">
            <div class="grid-modal-header">
                <h3 id="gridTitle" class="grid-title">Data Grid</h3>
                <div class="grid-controls">
                    <span onclick="toggleGridDock()" class="dock-btn" title="Dock to Sidebar">&#8601;</span>
                    <span class="close" onclick="document.getElementById('gridModal').style.display='none'"
                        style="cursor:pointer; font-size:18px;">&times;</span>
                </div>
            </div>
            <div id="gridBody" class="grid-body">
                <!-- Table will be injected here -->
            </div>
            <div
                style="padding:5px; background:#252525; border-top:1px solid #333; font-size:10px; color:#666; text-align:center;">
                Drag metrics here to add columns
            </div>
        </div>
    </div>

    <script src="map_renderer.js?v=24"></script>
    <script src="parser.js?v=23"></script>
    <script src="app.js?v=v76"></script>
</body>

</html>