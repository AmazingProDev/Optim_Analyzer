<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Cracker Pro - Nemo Visualizer</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì°</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css?v=31">
    <link rel="stylesheet" href="grid_styles.css?v=2">
    <link rel="stylesheet" href="additional_styles.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Emergency Styles to force visibility */
        #app {
            display: flex !important;
            flex-direction: column !important;
            height: 100vh !important;
        }

        header {
            display: flex !important;
            min-height: 60px !important;
            background: #2d2d2d !important;
            z-index: 9999 !important;
            border-bottom: 2px solid red !important;
        }

        #logs-sidebar {
            display: flex !important;
            width: 250px !important;
            z-index: 9998 !important;
        }

        main {
            display: flex !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Main Application Header -->
        <header id="mainHeader" class="main-header">
            <div class="logo">Log Cracker Pro</div>
            <div class="controls">
                <input type="file" id="fileInput" accept=".nmf, .nmfs, .csv, .txt, .xlsx, .xls">
                <label for="fileInput" class="btn">Load Log (NMF/CSV)</label>

                <input type="file" id="siteInput" accept=".xlsx, .xls, .csv">
                <label for="siteInput" class="btn btn-blue">Import Sites</label>

                <button id="siteSettingsBtn" class="btn btn-gray">‚öôÔ∏è Sites</button>
                <button id="exportKmlBtn" class="btn btn-green" title="Export current view to KML">üåç
                    KML</button>
                <button id="exportSitesKmlBtn" class="btn btn-green ml-2"
                    title="Export all sites to KML (Uniform Color)">üì° KML</button>
                <button id="themeSettingsBtn" class="btn btn-gray">üé® Theme</button>
                <button id="aiAnalyzeBtn" class="btn btn-gradient">
                    <span>‚ú®</span> AI Analyze
                </button>

                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="CGPS (Lat, Lng)" class="search-input">
                    <button id="searchBtn" class="search-btn-icon">üîç</button>
                    <button id="addPointBtn" class="search-btn-icon add-point-btn" title="Add User Point">üìç</button>
                </div>

                <span id="fileStatus">No file loaded</span>
            </div>

            <!-- Site Settings Panel -->
            <div id="siteSettingsPanel" class="settings-panel">
                <h4 class="settings-header">Site Settings</h4>

                <div class="setting-item">
                    <label class="setting-label">Range (m): <span id="valRange">100</span></label>
                    <input type="range" id="rangeSiteDist" min="50" max="300" step="50" value="100"
                        class="setting-input" aria-label="Site Range">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Beamwidth (¬∞): <span id="valBeam">35</span></label>
                    <input type="range" id="rangeIconBeam" min="10" max="180" step="5" value="35" class="setting-input"
                        aria-label="Icon Beamwidth">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Opacity: <span id="valOpacity">0.6</span></label>
                    <input type="range" id="rangeSiteOpacity" min="0.1" max="1" step="0.1" value="0.6"
                        class="setting-input" aria-label="Site Opacity">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Color By</label>
                    <select id="siteColorBy" class="setting-input site-color-mode" aria-label="Site Color Mode">
                        <option value="tech">Technology</option>
                        <option value="identity">Cell Identity (RNC/CID)</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Color Override</label>
                    <div class="site-color-picker-container">
                        <input type="color" id="pickerSiteColor" value="#3b82f6" class="site-color-picker"
                            aria-label="Site Color Picker">
                        <label class="site-checkbox-label"><input type="checkbox" id="checkSiteColorOverride">
                            Apply</label>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Labels</label>
                    <div class="site-names-container">
                        <label class="site-checkbox-label"><input type="checkbox" id="checkShowSiteNames"> Show
                            Site Names</label>
                        <label class="site-checkbox-label"><input type="checkbox" id="checkShowCellNames"> Show
                            Cell Names</label>
                    </div>
                </div>

                <div class="settings-footer-right">
                    <button id="closeSiteSettings" class="close-settings-btn">Close</button>
                </div>
            </div>

            <!-- Theme Settings Panel -->
            <div id="themeSettingsPanel" class="settings-panel theme-settings-panel-custom">
                <h4 class="settings-header">Thematic Analysis</h4>

                <div class="setting-item">
                    <label class="setting-label">Active Theme</label>
                    <select id="themeSelect" class="setting-input theme-select" aria-label="Active Theme">
                        <option value="level">Coverage (RSCP/RSRP)</option>
                        <option value="quality">Quality (EcNo/RSRQ)</option>
                    </select>
                </div>

                <div id="thresholdsContainer" class="thresholds-container">
                    <!-- Thresholds injected here by JS -->
                </div>

                <div class="theme-footer">
                    <button id="resetThemeBtn" class="btn theme-btn-reset">Reset</button>
                    <div class="theme-footer-actions">
                        <button id="applyThemeBtn" class="btn theme-btn-apply">Apply</button>
                        <button id="closeThemeSettings" class="btn theme-btn-close">Close</button>
                    </div>
                </div>
            </div>

            <div class="stats" id="statsDisplay">
                <!-- Stats will go here -->
            </div>
        </header>

        <main>
            <div id="logs-sidebar" class="logs-sidebar-flex">
                <h3>Loaded Logs</h3>
                <div id="logsList" class="logs-list-container">
                    <div class="empty-state">No logs loaded</div>
                </div>

                <!-- Docked Views Container REMOVED -->
            </div>

            <div id="center-pane" class="center-pane">
                <div id="map" class="map-container" ondrop="window.drop(event)" ondragover="window.allowDrop(event)">
                </div>

                <!-- Bottom Panel for Docked Views (Legacy/Bottom) -->
                <!-- Bottom Panel for Docked Views (Legacy/Bottom) -->
                <div id="bottomPanel" class="bottom-panel">
                    <div id="bottomResizer" class="bottom-resizer">
                        <div class="bottom-resizer-handle"></div>
                    </div>
                    <div id="bottomContent" class="bottom-content">
                        <!-- Docked Content Will Go Here -->
                        <div id="dockedChart" class="docked-pane-hidden">
                        </div>
                        <div id="dockedSignaling" class="docked-pane-hidden">
                        </div>
                        <div id="dockedGrid" class="docked-grid-container">
                            <div class="docked-item-header docked-grid-header-placeholder">
                                <!-- Placeholders if needed -->
                            </div>
                            <!-- Helper Container for body -->
                            <div id="dockedGridBody" class="docked-grid-body"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebar" class="hidden">
                <h3>Point Details</h3>
                <div id="pointDetails"></div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Signaling Modal -->
    <!-- Signaling Modal -->
    <div id="signalingModal" class="modal">
        <div class="modal-content signaling-modal-content">
            <div class="modal-header signaling-modal-header">
                <div class="signaling-header-left">
                    <h3 id="signalingModalTitle" class="signaling-modal-title">Signaling Data</h3>
                    <select id="signalingFilter" onchange="filterSignaling()" class="signaling-filter"
                        aria-label="Signaling Type Filter">
                        <option value="ALL">All Types</option>
                        <option value="RRC">RRC Only</option>
                        <option value="L3">L3 Only</option>
                    </select>
                </div>
                <span class="close signaling-close" onclick="closeSignalingModal()">&times;</span>
            </div>
            <div class="modal-body signaling-modal-body">
                <table class="data-table signaling-table">
                    <thead class="signaling-thead">
                        <tr>
                            <th class="th-padding">Time
                            </th>
                            <th class="th-padding">Type
                            </th>
                            <th class="th-padding">
                                Direction</th>
                            <th class="th-padding">Message
                            </th>
                            <th class="th-padding">Details
                            </th>
                        </tr>
                    </thead>
                    <tbody id="signalingTableBody">
                        <!-- Data rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Grid Modal -->
    <!-- Grid Modal -->
    <div id="gridModal" class="modal grid-modal-overlay">
        <div class="modal-content grid-modal-content">

            <!-- Header (Draggable) -->
            <div class="modal-header grid-modal-header grid-modal-header-custom">
                <h3 class="grid-title">Grid View
                </h3>
                <div class="grid-controls">
                    <button class="btn btn-sm btn-secondary" onclick="sortGrid()">Sort</button>
                    <button class="btn btn-sm btn-secondary" onclick="window.exportGridToCSV()">Export CSV</button>
                    <!-- Dock Button -->
                    <button class="dock-btn" onclick="toggleGridDock()" title="Dock">&#8595;</button>
                    <span class="close grid-close"
                        onclick="document.getElementById('gridModal').style.display='none'">&times;</span>
                </div>
            </div>

            <!-- Body -->
            <div id="gridBody" class="modal-body grid-body grid-modal-body-custom">
                <!-- Grid Table Generated via JS -->
                <div class="grid-placeholder">
                    Drag metrics from the sidebar here to add columns.<br>
                    (e.g. Serving RSCP, EcNo, SC, etc.)
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <!-- Chart Modal -->
    <div id="chartModal" class="modal">
        <div class="modal-content chart-modal-content">
            <div class="modal-header chart-modal-header">
                <h3 id="chartTitle" class="chart-title">Chart</h3>
                <span class="close chart-close" onclick="closeChartModal()">&times;</span>
            </div>
            <div class="chart-container">
                <canvas id="chartCanvas"></canvas>
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <!-- AI Analysis Modal -->
    <div id="aiModal" class="modal">
        <div class="modal-content ai-modal-content">
            <div class="modal-header ai-modal-header">
                <h3 class="ai-modal-title">
                    <span class="ai-icon-large">‚ú®</span> AI Drive Test Analyst
                </h3>
                <span class="close ai-close" onclick="closeAIModal()">&times;</span>
            </div>

            <div class="modal-body ai-modal-body">

                <!-- API Key Section -->
                <div id="aiApiKeySection" class="ai-section">

                    <!-- Provider Selector -->
                    <div class="ai-provider-row">
                        <label class="ai-label-small">AI Provider:</label>
                        <div class="ai-provider-options">
                            <label class="ai-radio-label">
                                <input type="radio" name="aiProvider" value="gemini" checked
                                    onchange="toggleAIProvider()" class="ai-radio-input">
                                <span class="ai-radio-text">Google Gemini</span>
                            </label>
                            <label class="ai-radio-label">
                                <input type="radio" name="aiProvider" value="openai" onchange="toggleAIProvider()"
                                    class="ai-radio-input">
                                <span class="ai-radio-text">OpenAI ChatGPT</span>
                            </label>
                        </div>
                    </div>

                    <p class="ai-subtext">Enter your API Key to enable
                        analysis. Keys are stored locally.</p>

                    <div class="ai-model-select-wrapper">
                        <label for="geminiModelSelect" class="ai-model-select-label">Model:</label>
                        <select id="geminiModelSelect" class="ai-model-select">
                            <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp (New)</option>
                            <option value="gemini-flash-latest">Gemini Flash Latest</option>
                            <option value="gemini-pro-latest">Gemini Pro Latest</option>
                            <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Latest)</option>
                            <option value="gemini-1.5-flash-001">Gemini 1.5 Flash (v001)</option>
                            <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Latest)</option>
                            <option value="gemini-pro">Gemini 1.0 Pro</option>
                        </select>
                    </div>

                    <!-- Gemini Key Input -->
                    <div id="geminiKeyContainer" class="ai-key-container">
                        <input type="password" id="geminiApiKey" placeholder="Paste Gemini API Key (AIza...)"
                            class="ai-key-input">
                        <button onclick="window.checkGeminiModels()" class="ai-check-btn">Check
                            Models</button>
                    </div>

                    <!-- OpenAI Key Input (Hidden by default) -->
                    <div id="openaiKeyContainer" class="ai-key-container-hidden">
                        <input type="password" id="openaiApiKey" placeholder="Paste OpenAI API Key (sk-...)"
                            class="ai-key-input">
                    </div>
                    <div id="aiModelDebugLog" class="ai-debug-log">
                    </div>
                </div>

                <!-- Loading State -->
                <div id="aiLoading" class="ai-loading">
                    <div class="ai-spinner"></div>
                    <p class="ai-loading-text">Analyzing log data...</p>
                </div>

                <!-- Result Content -->
                <div id="aiContent" class="ai-content-wrapper">
                    <div class="ai-placeholder-wrapper">
                        <p>Click "Analyze" to generate insights from the current log.</p>
                        <button onclick="window.runAIAnalysis()" id="runAnalysisBtn" class="ai-analyze-btn">
                            Generate Analysis
                        </button>
                    </div>
                </div>

            </div> <!-- End modal-body -->
        </div> <!-- End modal-content -->
    </div> <!-- End aiModal -->

    <!-- Context Menu -->
    <!-- Context Menu -->
    <!-- Context Menu -->
    <div id="metricContextMenu" class="metric-context-menu">
        <div class="menu-item" onclick="window.handleContextAction('map')">Open in Map</div>
        <div class="menu-item" onclick="window.handleContextAction('chart')">Open in Chart</div>
        <div class="menu-item" onclick="window.handleContextAction('grid')">Open in Grid</div>
    </div>




    <!-- Floating Info Panel (Draggable) -->
    <div id="floatingInfoPanel" class="floating-info-panel">
        <!-- Header (Drag Handle) -->
        <div id="infoPanelHeader" class="infoPanelHeader info-panel-header">
            <span class="info-panel-title">Point Details</span>
            <span onclick="document.getElementById('floatingInfoPanel').style.display='none'"
                class="info-panel-close">&times;</span>
        </div>
        <!-- Content -->
        <div id="infoPanelContent" class="info-panel-content">
            <div class="info-panel-placeholder">Select a point to view details</div>
        </div>
    </div>

    <script src="map_renderer.js?v=62"></script>
    <script src="parser.js?v=43"></script>
    <script src="theme_config.js?v=2"></script>
    <script src="app.js?v=v113"></script>
    <!-- User Point Modal -->
    <div id="userPointModal" class="modal">
        <div class="modal-content user-point-modal-content">
            <div class="modal-header user-point-modal-header">
                <h3>Add User Point</h3>
                <span class="close"
                    onclick="document.getElementById('userPointModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body user-point-modal-body">
                <div class="up-input-group">
                    <label class="up-label">Name</label>
                    <input type="text" id="upName" placeholder="Point Name" class="up-input">
                </div>
                <div class="up-input-row">
                    <div class="up-input-item">
                        <label class="up-label">Latitude</label>
                        <input type="number" id="upLat" placeholder="33.xxx" step="any" class="up-input">
                    </div>
                    <div class="up-input-item">
                        <label class="up-label">Longitude</label>
                        <input type="number" id="upLng" placeholder="-7.xxx" step="any" class="up-input">
                    </div>
                </div>
                <div class="up-footer">
                    <button id="submitUserPoint" class="btn up-submit-btn">Add to Map</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>