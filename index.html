<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Cracker Pro - Nemo Visualizer</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì°</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css?v=31">
    <link rel="stylesheet" href="grid_styles.css?v=2">
    <link rel="stylesheet" href="additional_styles.css?v=2">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Emergency Styles to force visibility */
        #app {
            display: flex !important;
            flex-direction: column !important;
            height: 100vh !important;
        }

        header {
            display: flex !important;
            min-height: 60px !important;
            background: #2d2d2d !important;
            z-index: 9999 !important;
            border-bottom: 2px solid red !important;
        }

        #logs-sidebar {
            display: flex !important;
            width: 250px !important;
            z-index: 9998 !important;
        }

        main {
            display: flex !important;
        }
    </style>
</head>

<body>
    <div id="app">
        <!-- Main Application Header -->
        <header id="mainHeader" class="main-header">
            <div class="logo">Log Cracker Pro</div>
            <div class="controls">
                <input type="file" id="fileInput" accept=".nmf, .nmfs, .csv, .txt, .xlsx, .xls">
                <label for="fileInput" class="btn">Load Log (NMF/CSV)</label>

                <input type="file" id="siteInput" accept=".xlsx, .xls, .csv" style="display:none;">
                <label for="siteInput" class="btn" style="background:#2563eb;">Import Sites</label>

                <button id="siteSettingsBtn" class="btn" style="background:#4b5563;">‚öôÔ∏è Sites</button>
                <button id="themeSettingsBtn" class="btn" style="background:#4b5563;">üé® Theme</button>
                <button id="aiAnalyzeBtn" class="btn"
                    style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; border: none; display: flex; align-items: center; gap: 5px;">
                    <span>‚ú®</span> AI Analyze
                </button>

                <div
                    style="display:flex; align-items:center; background:#333; padding:2px 5px; border-radius:4px; border:1px solid #555;">
                    <input type="text" id="searchInput" placeholder="CGPS (Lat, Lng)"
                        style="background:none; border:none; color:#ddd; width:120px; font-size:12px; outline:none;">
                    <button id="searchBtn" style="background:none; border:none; cursor:pointer;">üîç</button>
                </div>

                <span id="fileStatus">No file loaded</span>
            </div>

            <!-- Site Settings Panel -->
            <div id="siteSettingsPanel" class="settings-panel">
                <h4 class="settings-header">Site Settings</h4>

                <div class="setting-item">
                    <label class="setting-label">Range (m): <span id="valRange">100</span></label>
                    <input type="range" id="rangeSiteDist" min="50" max="300" step="50" value="100"
                        class="setting-input" aria-label="Site Range">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Beamwidth (¬∞): <span id="valBeam">35</span></label>
                    <input type="range" id="rangeIconBeam" min="10" max="180" step="5" value="35" class="setting-input"
                        aria-label="Icon Beamwidth">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Opacity: <span id="valOpacity">0.6</span></label>
                    <input type="range" id="rangeSiteOpacity" min="0.1" max="1" step="0.1" value="0.6"
                        class="setting-input" aria-label="Site Opacity">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Color By</label>
                    <select id="siteColorBy" class="setting-input"
                        style="background:#333; color:#fff; border:1px solid #555;">
                        <option value="tech">Technology</option>
                        <option value="identity">Cell Identity (RNC/CID)</option>
                    </select>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Color Override</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="color" id="pickerSiteColor" value="#3b82f6"
                            style="border:none; width:30px; height:30px; cursor:pointer;"
                            aria-label="Site Color Picker">
                        <label style="font-size:11px; color:#888;"><input type="checkbox" id="checkSiteColorOverride">
                            Apply</label>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Labels</label>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <label style="font-size:11px; color:#888;"><input type="checkbox" id="checkShowSiteNames"> Show
                            Site Names</label>
                        <label style="font-size:11px; color:#888;"><input type="checkbox" id="checkShowCellNames"> Show
                            Cell Names</label>
                    </div>
                </div>

                <div style="text-align:right;">
                    <button id="closeSiteSettings"
                        style="background:#555; color:white; border:none; padding:4px 10px; cursor:pointer; font-size:11px; border-radius:3px;">Close</button>
                </div>
            </div>

            <!-- Theme Settings Panel -->
            <div id="themeSettingsPanel" class="settings-panel" style="display:none; right:150px;">
                <h4 class="settings-header">Thematic Analysis</h4>

                <div class="setting-item">
                    <label class="setting-label">Active Theme</label>
                    <select id="themeSelect" class="setting-input" style="color:#333;">
                        <option value="level">Coverage (RSCP/RSRP)</option>
                        <option value="quality">Quality (EcNo/RSRQ)</option>
                    </select>
                </div>

                <div id="thresholdsContainer" style="margin-top:10px; max-height:300px; overflow-y:auto;">
                    <!-- Thresholds injected here by JS -->
                </div>

                <div style="margin-top:10px; display:flex; justify-content:space-between;">
                    <button id="resetThemeBtn" class="btn" style="background:#ef4444; font-size:11px;">Reset</button>
                    <div style="gap:5px; display:flex;">
                        <button id="applyThemeBtn" class="btn"
                            style="background:#22c55e; font-size:11px;">Apply</button>
                        <button id="closeThemeSettings" class="btn"
                            style="background:#555; font-size:11px;">Close</button>
                    </div>
                </div>
            </div>

            <div class="stats" id="statsDisplay">
                <!-- Stats will go here -->
            </div>
        </header>

        <main>
            <div id="logs-sidebar" style="display:flex; flex-direction:column;">
                <h3>Loaded Logs</h3>
                <div id="logsList" style="flex:1; overflow-y:auto; margin-bottom:10px;">
                    <div class="empty-state">No logs loaded</div>
                </div>

                <!-- Docked Views Container REMOVED -->
            </div>

            <div id="center-pane"
                style="flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden;">
                <div id="map" style="flex: 1;" ondrop="window.drop(event)" ondragover="window.allowDrop(event)"></div>

                <!-- Bottom Panel for Docked Views (Legacy/Bottom) -->
                <div id="bottomPanel"
                    style="height: 0; display: none; flex-direction: column; background: #1e1e1e; border-top: 1px solid #444;">
                    <div id="bottomResizer"
                        style="height: 5px; background: #333; cursor: ns-resize; flex-shrink: 0; display: flex; justify-content: center; align-items: center;">
                        <div style="width: 30px; height: 2px; background: #555; border-radius: 1px;"></div>
                    </div>
                    <div id="bottomContent" style="flex: 1; display: flex; overflow: hidden;">
                        <!-- Docked Content Will Go Here -->
                        <div id="dockedChart"
                            style="flex: 1; display: none; border-right: 1px solid #333; position: relative; flex-direction: column;">
                        </div>
                        <div id="dockedSignaling"
                            style="flex: 1; display: none; border-right: 1px solid #333; position: relative; flex-direction: column;">
                        </div>
                        <div id="dockedGrid"
                            style="flex: 1; display: none; position: relative; flex-direction: column;">
                            <div class="docked-item-header"
                                style="display:none; /* Dynamic Header usually handled by moving modal header */">
                                <!-- Placeholders if needed -->
                            </div>
                            <!-- Helper Container for body -->
                            <div id="dockedGridBody" style="flex:1; overflow:auto;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="sidebar" class="hidden">
                <h3>Point Details</h3>
                <div id="pointDetails"></div>
            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Signaling Modal -->
    <div id="signalingModal" class="modal">
        <div class="modal-content"
            style="width:80%; max-width:900px; background:#1e1e1e; border:1px solid #444; height:80vh; display:flex; flex-direction:column; padding:0;">
            <div class="modal-header"
                style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <h3 id="signalingModalTitle" style="margin:0; color:#ddd;">Signaling Data</h3>
                    <select id="signalingFilter" onchange="filterSignaling()"
                        style="background:#333; color:#eee; border:1px solid #555; padding:4px 8px; border-radius:4px; font-size:12px;"
                        aria-label="Signaling Type Filter">
                        <option value="ALL">All Types</option>
                        <option value="RRC">RRC Only</option>
                        <option value="L3">L3 Only</option>
                    </select>
                </div>
                <span class="close" onclick="closeSignalingModal()"
                    style="color:#aaa; cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div class="modal-body" style="flex:1; overflow-y:auto; padding:0;">
                <table class="data-table" style="width:100%; border-collapse:collapse; font-size:12px;">
                    <thead style="position:sticky; top:0; background:#252525; z-index:10;">
                        <tr>
                            <th style="text-align:left; padding:8px;">Time
                            </th>
                            <th style="text-align:left; padding:8px;">Type
                            </th>
                            <th style="text-align:left; padding:8px;">
                                Direction</th>
                            <th style="text-align:left; padding:8px;">Message
                            </th>
                            <th style="text-align:left; padding:8px;">Details
                            </th>
                        </tr>
                    </thead>
                    <tbody id="signalingTableBody">
                        <!-- Data rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Grid Modal -->
    <div id="gridModal" class="modal"
        style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4);">
        <div class="modal-content"
            style="background-color: #1e1e1e; margin: 5% auto; padding: 0; border: 1px solid #444; width: 80%; height: 70%; display: flex; flex-direction: column; resize: both; overflow: hidden; position: relative;">

            <!-- Header (Draggable) -->
            <div class="modal-header grid-modal-header"
                style="padding: 10px; background: #252525; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; cursor: move; flex-shrink: 0;">
                <h3 class="grid-title" style="margin: 0; font-size: 14px; color: #eee; pointer-events: none;">Grid View
                </h3>
                <div class="grid-controls" style="display: flex; gap: 8px; pointer-events: auto;">
                    <button class="btn btn-sm btn-secondary" onclick="sortGrid()">Sort</button>
                    <button class="btn btn-sm btn-secondary" onclick="window.exportGridToCSV()">Export CSV</button>
                    <!-- Dock Button -->
                    <button class="dock-btn" onclick="toggleGridDock()" title="Dock"
                        style="background:#3b82f6; color:white; border:none; padding:4px 10px; cursor:pointer; font-size:14px; border-radius:3px;">&#8595;</button>
                    <span class="close" onclick="document.getElementById('gridModal').style.display='none'"
                        style="color: #aaa; font-size: 24px; font-weight: bold; cursor: pointer; line-height: 16px;">&times;</span>
                </div>
            </div>

            <!-- Body -->
            <div id="gridBody" class="modal-body grid-body"
                style="flex: 1; padding: 10px; overflow: auto; color: #ddd; position: relative;">
                <!-- Grid Table Generated via JS -->
                <div style="text-align:center; color:#666; padding:20px;">
                    Drag metrics from the sidebar here to add columns.<br>
                    (e.g. Serving RSCP, EcNo, SC, etc.)
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div id="chartModal" class="modal">
        <div class="modal-content"
            style="width:90%; height:90%; background:#1e1e1e; border:1px solid #444; display:flex; flex-direction:column; padding:0;">
            <div class="modal-header"
                style="padding:10px; background:#252525; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="chartTitle" style="margin:0; font-size:16px; color:#ddd;">Chart</h3>
                <span class="close" onclick="closeChartModal()"
                    style="color:#aaa; cursor:pointer; font-size:24px;">&times;</span>
            </div>
            <div style="flex:1; position:relative; padding:10px; min-height:0;">
                <canvas id="chartCanvas"></canvas>
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div id="aiModal" class="modal">
        <div class="modal-content"
            style="width: 80%; max-width: 800px; height: 80vh; background: #1e1e1e; border: 1px solid #444; display: flex; flex-direction: column; padding: 0;">
            <div class="modal-header"
                style="padding: 15px; background: #252525; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; display: flex; align-items: center; gap: 8px; color: #e2e8f0;">
                    <span style="font-size: 20px;">‚ú®</span> AI Drive Test Analyst
                </h3>
                <span class="close" onclick="closeAIModal()"
                    style="color: #aaa; cursor: pointer; font-size: 24px;">&times;</span>
            </div>

            <div class="modal-body"
                style="flex: 1; padding: 20px; overflow-y: auto; color: #e2e8f0; font-family: 'Inter', sans-serif;">

                <!-- API Key Section -->
                <div id="aiApiKeySection"
                    style="margin-bottom: 20px; padding: 15px; background: #2d2d2d; border-radius: 8px; border: 1px solid #3f3f46;">

                    <!-- Provider Selector -->
                    <div
                        style="margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;">
                        <label style="font-size: 13px; color: #ccc;">AI Provider:</label>
                        <div style="display: flex; gap: 15px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="aiProvider" value="gemini" checked
                                    onchange="toggleAIProvider()" style="margin-right: 6px;">
                                <span style="color: #e2e8f0; font-size: 13px;">Google Gemini</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="aiProvider" value="openai" onchange="toggleAIProvider()"
                                    style="margin-right: 6px;">
                                <span style="color: #e2e8f0; font-size: 13px;">OpenAI ChatGPT</span>
                            </label>
                        </div>
                    </div>

                    <p style="margin: 0 0 10px 0; font-size: 14px; color: #94a3b8;">Enter your API Key to enable
                        analysis. Keys are stored locally.</p>

                    <div style="margin-bottom: 10px;">
                        <label for="geminiModelSelect"
                            style="font-size: 12px; color: #ccc; display: block; margin-bottom: 4px;">Model:</label>
                        <select id="geminiModelSelect"
                            style="width: 100%; padding: 8px; background: #18181b; color: white; border: 1px solid #4b5563; border-radius: 6px;">
                            <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp (New)</option>
                            <option value="gemini-flash-latest">Gemini Flash Latest</option>
                            <option value="gemini-pro-latest">Gemini Pro Latest</option>
                            <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Latest)</option>
                            <option value="gemini-1.5-flash-001">Gemini 1.5 Flash (v001)</option>
                            <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro (Latest)</option>
                            <option value="gemini-pro">Gemini 1.0 Pro</option>
                        </select>
                    </div>

                    <!-- Gemini Key Input -->
                    <div id="geminiKeyContainer" style="display: flex; gap: 10px; align-items:center;">
                        <input type="password" id="geminiApiKey" placeholder="Paste Gemini API Key (AIza...)"
                            style="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #4b5563; background: #18181b; color: white;">
                        <button onclick="window.checkGeminiModels()"
                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid #4b5563; background: #333; color: white; white-space: nowrap; cursor: pointer;">Check
                            Models</button>
                    </div>

                    <!-- OpenAI Key Input (Hidden by default) -->
                    <div id="openaiKeyContainer" style="display: none; gap: 10px; align-items:center;">
                        <input type="password" id="openaiApiKey" placeholder="Paste OpenAI API Key (sk-...)"
                            style="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #4b5563; background: #18181b; color: white;">
                    </div>
                    <div id="aiModelDebugLog"
                        style="margin-top: 10px; font-size: 11px; color: #888; font-family: monospace; white-space: pre-wrap; display:none; background: #111; padding: 10px; border-radius: 4px;">
                    </div>
                </div>

                <!-- Loading State -->
                <div id="aiLoading"
                    style="display: none; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                    <div class="ai-spinner"></div>
                    <p style="margin-top: 15px; color: #94a3b8;">Analyzing log data...</p>
                </div>

                <!-- Result Content -->
                <div id="aiContent" style="line-height: 1.6;">
                    <div style="text-align: center; color: #64748b; margin-top: 40px;">
                        <p>Click "Analyze" to generate insights from the current log.</p>
                        <button onclick="window.runAIAnalysis()" id="runAnalysisBtn"
                            style="margin-top: 10px; padding: 10px 20px; background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            Generate Analysis
                        </button>
                    </div>
                </div>

            </div> <!-- End modal-body -->
        </div> <!-- End modal-content -->
    </div> <!-- End aiModal -->

    <!-- Context Menu -->
    <!-- Context Menu -->
    <div id="metricContextMenu" class="context-menu"
        style="display: none; position: absolute; z-index: 10000; background: #2d2d2d; border: 1px solid #444; border-radius: 4px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); padding: 5px 0; min-width: 150px;">
        <div class="menu-item" onclick="window.handleContextAction('map')"
            style="padding: 8px 15px; cursor: pointer; color: #e0e0e0;">Open in Map</div>
        <div class="menu-item" onclick="window.handleContextAction('chart')"
            style="padding: 8px 15px; cursor: pointer; color: #e0e0e0;">Open in Chart</div>
        <div class="menu-item" onclick="window.handleContextAction('grid')"
            style="padding: 8px 15px; cursor: pointer; color: #e0e0e0;">Open in Grid</div>
    </div>




    <!-- Floating Info Panel (Draggable) -->
    <div id="floatingInfoPanel"
        style="display:none; position:fixed; top:80px; right:20px; width:auto; min-width:280px; max-width:500px; background:rgba(30, 30, 30, 0.95); backdrop-filter:blur(5px); border:1px solid #444; border-radius:8px; z-index:3000; box-shadow:0 8px 30px rgba(0,0,0,0.5); font-family: 'Inter', sans-serif;">
        <!-- Header (Drag Handle) -->
        <div id="infoPanelHeader"
            style="padding:10px; background:#252525; border-bottom:1px solid #333; border-radius:8px 8px 0 0; cursor:move; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:12px; font-weight:600; color:#ddd;">Point Details</span>
            <span onclick="document.getElementById('floatingInfoPanel').style.display='none'"
                style="cursor:pointer; color:#888; font-size:16px;">&times;</span>
        </div>
        <!-- Content -->
        <div id="infoPanelContent" style="padding:10px; color:#eee; max-height:400px; overflow-y:auto;">
            <div style="font-size:12px; color:#888; text-align:center;">Select a point to view details</div>
        </div>
    </div>

    <script src="map_renderer.js?v=62"></script>
    <script src="parser.js?v=43"></script>
    <script src="theme_config.js?v=2"></script>
    <script src="app.js?v=v113"></script>
</body>

</html>